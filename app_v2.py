import streamlit as st
import firebase_admin
from firebase_admin import credentials, firestore

# 1. ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช (ููุณ ุงูููุฏ ุงููุงุฌุญ)
if not firebase_admin._apps:
    try:
        fb_dict = dict(st.secrets["firebase_secrets"])
        fb_dict["private_key"] = fb_dict["private_key"].replace("\\n", "\n")
        cred = credentials.Certificate(fb_dict)
        firebase_admin.initialize_app(cred)
    except Exception as e:
        st.error(f"ุฎุทุฃ ูู ุงูุงุชุตุงู: {e}")

db = firestore.client()

# --- ุฅุนุฏุงุฏุงุช ุงูุตูุญุฉ ูุดูููุง ---
st.set_page_config(page_title="ููุธููุฉ ุฅุฏุงุฑุฉ ุงูุทุงูุจ", layout="wide") # ุฌุนู ุงูุตูุญุฉ ุนุฑูุถุฉ ูุชุณุน ุงูุจูุงูุงุช
st.title("๐ ููู ุงูุทุงูุจ ุงููุชูุงูู")

uid = st.text_input("ุจุฑุฌุงุก ุฅุฏุฎุงู ุงูุฑูู ุงููููู ููุงุณุชุนูุงู")

if st.button("ุนุฑุถ ุงูููู ุงููุงูู"):
    if uid:
        try:
            doc = db.collection('students').document(uid).get()
            if doc.exists:
                res = doc.to_dict()
                st.success(f"โ ุชู ุชุญููู ุจูุงูุงุช ุงูุทุงูุจ: {res.get('ุงูุงุณู', '')}")

                # --- ุงูุฌุฒุก ุงูุฃูู: ุงูุจูุงูุงุช ุงูุดุฎุตูุฉ ูุงูุฃูุงุฏูููุฉ ---
                col1, col2 = st.columns(2)
                
                with col1:
                    st.header("๐ค ุงูุจูุงูุงุช ุงูุดุฎุตูุฉ")
                    st.write(f"**ุงูุงุณู ุจุงููุงูู:** {res.get('ุงูุงุณู', '---')}")
                    st.write(f"**ุงูุนููุงู:** {res.get('ุงูุนููุงู', '---')}")
                    st.write(f"**ุฑูู ุงููุงุชู:** {res.get('ุงููุงุชู', '---')}")

                with col2:
                    st.header("๐ ุงูุจูุงูุงุช ุงูุฃูุงุฏูููุฉ")
                    st.write(f"**ุงููุฑุญูุฉ ุงูุฏุฑุงุณูุฉ:** {res.get('ุงููุฑุญูุฉ', '---')}")
                    st.write(f"**ุงูุตู ุงูุฏุฑุงุณู:** {res.get('ุงูุตู', '---')}")
                    st.write(f"**ุญุงูุฉ ุงูููุฏ:** {res.get('ุงูุญุงูุฉ', '---')}")

                st.divider()

                # --- ุงูุฌุฒุก ุงูุซุงูู: ุงููุตุฑููุงุช ุงูุฏุฑุงุณูุฉ ---
                st.header("๐ฐ ุงูุดุคูู ุงููุงููุฉ")
                
                # ุงููุตุฑููุงุช ุงููุณุชุญูุฉ ูู ุงูุฃุนูู (ุจุฏูู ุชุฌููุน)
                st.subheader("๐ ุงููุตุฑููุงุช ุงููุณุชุญูุฉ")
                st.info(f"ุฅุฌูุงูู ุงููุตุฑููุงุช ุงููุทููุจุฉ ููุนุงู ุงูุฏุฑุงุณู: {res.get('ุงููุตุฑููุงุช_ุงููุณุชุญูุฉ', 0)} ุฌููู ูุตุฑู")

                # ุฌุฏูู ุจูุงูุงุช ุงูุณุฏุงุฏ ุงูุณุงุจูุฉ ูู ุงูุฃุณูู
                st.subheader("๐ ุณุฌู ุงูุณุฏุงุฏ ุงููุงูู")
                # ููุงุญุธุฉ: ุฅุฐุง ููุช ูุฎุฒู ุงูุณุฏุงุฏ ููุงุฆูุฉ (List) ูู Firebase ุณุชุธูุฑ ููุง
                payments = res.get('ุณุฌู_ุงูุณุฏุงุฏ', []) # ุชุฃูุฏ ูู ุงุณู ุงูุฎุงูุฉ ูู Firebase
                if payments:
                    st.table(payments)
                else:
                    st.write("ูุง ุชูุฌุฏ ุนูููุงุช ุณุฏุงุฏ ุณุงุจูุฉ ูุณุฌูุฉ.")

                st.divider()

                # --- ุงูุฌุฒุก ุงูุซุงูุซ: ุงูุดูุงูู ---
                st.header("๐ ูุณู ุงูุดูุงูู")
                st.write(f"**ุขุฎุฑ ุดููู ููุฏูุฉ:** {res.get('ุงูุดูุงูู', 'ูุง ููุฌุฏ')}")
                st.write(f"**ุฑุฏ ุงูุฅุฏุงุฑุฉ:** {res.get('ุงูุฑุฏ', 'ููุฏ ุงููุฑุงุฌุนุฉ')}")

            else:
                st.error("โ ุนุฐุฑุงูุ ูุฐุง ุงูุฑูู ุงููููู ุบูุฑ ูุณุฌู.")
        except Exception
